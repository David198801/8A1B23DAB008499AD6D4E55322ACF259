https://opendocs.alipay.com/open/270/105899



接口文档

https://opendocs.alipay.com/apis/api_1/alipay.trade.page.pay?scene=API002020081300013629



三方：客户端，服务端，支付宝



1.客户端向服务端请求，发送订单信息参数（接口文档中的“请求参数”）

2.服务端向支付宝接口请求，发送订单信息参数的json字符串、appid、app私钥、支付宝公钥、return和notify页面的url等信息（参考demo示例代码），支付宝验证后重定向至支付宝页面

3.客户端在支付宝页面进行登录和支付操作

4.1支付完成，支付宝响应信息至客户端，客户端向服务端的return url发起GET请求，可以转发至页面展示交易信息

4.2支付宝向服务端的notify url发送异步POST请求，服务端验证签名和其他参数，然后向支付宝响应成功/失败数据。(out.println("success");或out.println("fail");)

4.3因网络问题未收到notify请求，或不选择notify验证方式（notify url传null），可以由服务端主动向支付宝发送查询alipay.trade.query请求







注意： 

- 由于同步返回的不可靠性，支付结果必须以异步通知或查询接口返回为准，不能依赖同步跳转。

- 商户系统接收到异步通知以后，必须通过验签（验证通知中的 sign 参数）来确保支付通知是由支付宝发送的。详细验签规则请参见 异步通知验签。

- 接收到异步通知并验签通过后，请务必核对通知中的 app_id、out_trade_no、total_amount 等参数值是否与请求中的一致，并根据 trade_status 进行后续业务处理。

- 在支付宝端，partnerId 与 out_trade_no 唯一对应一笔单据，商户端保证不同次支付 out_trade_no 不可重复；若重复，支付宝会关联到原单据，基本信息一致的情况下会以原单据为准进行支付。







支付宝支付接口中notify_url 与 return_url 的区别是什么

https://blog.csdn.net/qq_36850813/article/details/81064181

一、return_url

1、同步返回接口，作为参数传递给支付宝

2、用户付款成功后，从支付宝跳转到这个页面

3、在这个页面中加入相关业务处理，比如更新记录，标记付款成功信息。

4、需要对支付宝传递过来的签名进行认证。

5、用来展现成功付款信息给前台付款用户。

6、支付宝那边只返回一次。

7、由于用户在付款完成后，直接关闭付款页面，不跳转到return_url的页面，会导致return_url的相关业务处理不了。



二、notify_url

1、异步通知接口，作为参数传递给支付宝。

2、如果不传递，则不通知。

3、相关业务逻辑应该和return_url中相同。

4、返回字符串"success"或者"fail"，不能带有任何HTML信息。

5、付款成功后就通知一次，如果不成功，1分钟、3分钟、10分钟、半个小时。。。后再通知，直到返回success。

6、过期时间是48小时，如果48小时内都通知不成功，那么就不再通知。